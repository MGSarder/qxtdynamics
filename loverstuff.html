<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Góc nhỏ của mụi và max</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fff0f6;
      --card:#ffffff;
      --muted:#b86b87;
      --accent:#ff6bcb;
      --accent-2:#ff9ad5;
      --shadow: 0 10px 30px rgba(255,105,180,0.08);
      --max-width:980px;
      --gap:18px;
      --radius:18px;
      --base-font:16px;
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    /* Responsive base font */
    html { font-size: clamp(14px, 1.6vw, 16px); }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),#ffeef8 60%);
      color:#2b1330;
      display:flex;
      justify-content:center;
      padding:clamp(12px,3.5vw,36px);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{width:100%;max-width:var(--max-width)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px; gap:12px}
    .title-block{display:flex;flex-direction:column;align-items:center;padding-left:0px}
    header h1{margin:0;font-size:clamp(18px,3.2vw,26px);letter-spacing:0.3px}
    header p{margin:6px 0 0;color:var(--muted);font-size:clamp(12px,2.2vw,14px)}
    .user-controls { display:flex; gap:8px; align-items:center; }
    .user-chip{
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    gap:4px;
    padding:8px 18px;
    background:#fff1f8;
    border-radius:999px;
    border:1px solid rgba(255,140,190,0.18);
    color:#5a1231;
    min-width:80px;
    text-align:center;
    font-weight:600;
    }

    
    .link-btn{background:transparent;border:0;color:#5a1231;cursor:pointer;font-weight:600;font-size:0.95rem}

    .uploader{
      background:linear-gradient(180deg,var(--card),#fff);
      padding:clamp(10px,3vw,18px);
      border-radius:20px;
      box-shadow:var(--shadow);
      display:flex;
      gap:12px;
      align-items:center;
      border:1px solid rgba(255,140,190,0.18);
      margin-bottom:8px;
    }
    .uploader .left{flex:1}
    .filewrap{display:flex;gap:8px;align-items:center;width:100%}
    .filebtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:12px;
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#fff;
      border:0;
      cursor:pointer;
      font-weight:600;
      box-shadow:0 6px 18px rgba(255,105,180,0.14);
      font-size:0.95rem;
    }
    .uploader input[type="file"]{display:none}
    .uploader input[type="text"]{width:100%;padding:10px;border-radius:12px;border:1px solid #ffd6ec;background:#fff8fb;font-size:0.95rem}
    .note{font-size:0.9rem;color:var(--muted);margin-top:8px}
    .preview{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .thumb{width:68px;height:68px;border-radius:10px;overflow:hidden;position:relative;border:1px solid rgba(255,140,190,0.18);background:#fff}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .remove{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.45);color:#fff;border-radius:999px;padding:2px 6px;cursor:pointer;font-size:11px}
    .thumb .label{position:absolute;left:6px;bottom:6px;background:rgba(255,255,255,0.9);padding:2px 6px;border-radius:6px;font-size:10px}

    /* Desktop / default grid */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:var(--gap);
      margin-top:18px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      border:1px solid rgba(255,140,190,0.08);
      transition:transform .22s ease;
    }

    /* Desktop image wrapper: consistent height and cover */
    .imgwrap{
      position:relative;
      width:100%;
      height: clamp(180px, 22vw, 360px);
      overflow:hidden;
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      background:#f8eef4;
    }
    .card img{
      display:block;
      width:100%;
      height:100%;
      object-fit:cover; /* desktop: fill and crop */
      object-position:center;
    }

    .heart{position:absolute;right:12px;top:12px;background:rgba(255,255,255,0.9);padding:8px;border-radius:999px;box-shadow:0 6px 18px rgba(255,105,180,0.08);cursor:pointer}
    .meta{padding:12px}
    .caption{margin:0 0 8px;font-weight:700;color:#3a0f2e;font-size:1rem}
    .meta .meta-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .author{font-size:0.95rem;color:#6a1a3a;font-weight:700}
    .time{font-size:0.85rem;color:var(--muted);margin-bottom:8px}
    .comments{border-top:1px solid #fff0f4;padding:10px;background:linear-gradient(180deg,rgba(255,250,253,0.7),transparent)}
    .comment{font-size:0.95rem;padding:8px 0;border-bottom:1px dashed rgba(255,180,210,0.25)}
    .comment:last-child{border-bottom:0}
    .comment small{display:block;color:var(--muted);font-size:0.8rem}
    .comment .c-author{font-weight:700;color:#6a1a3a}
    .comment-form{display:flex;gap:8px;margin-top:10px}
    .comment-form input{flex:1;padding:8px;border-radius:12px;border:1px solid #ffd6ec;background:#fff8fb;font-size:0.95rem}
    .comment-form button{padding:8px 12px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;cursor:pointer;font-size:0.95rem}
    .commenting-as{font-size:0.9rem;color:#6a1a3a;margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .commenting-as strong{background:#fff1f8;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,140,190,0.18)}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn-ghost{background:transparent;border:1px dashed rgba(255,140,190,0.25);padding:8px;border-radius:10px;cursor:pointer;color:#7a3750}
    footer{margin-top:12px;text-align:center;color:#0a0004;font-size:0.95rem}
    .modal-backdrop{position:fixed;inset:0;background:rgba(20,10,20,0.4);display:flex;align-items:center;justify-content:center}
    .modal{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);width:300px}
    .modal h3{margin:0 0 8px}
    .modal input{width:100%;padding:10px;border-radius:10px;border:1px solid #ffd6ec;margin-bottom:8px}
    .card:hover{transform:translateY(-6px)}
    .filebtn:active{transform:translateY(1px)}

    /* ---------- Decorative underlay ---------- */
    .underlay{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      overflow:visible;
    }
    .underlay .u-img{
      position:absolute;
      width: clamp(72px, 12vw, 320px);
      height: auto;
      opacity: 0.9;
      user-select: none;
      pointer-events: none;
      transition: transform .28s ease, opacity .28s ease, width .28s ease;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,0.06));
      border-radius:8px;
      object-fit:cover;
    }
    .underlay .u1{ left: 6%;  top: 60%; transform: translateY(-50%) rotate(-5deg); max-width:180px; opacity:0.65; }
    .underlay .u2{ left: 50%; top: 58%; transform: translate(-50%,-50%) rotate(2deg); width: clamp(120px, 42vw, 520px); opacity:0.55; }
    .underlay .u3{ left: 10%; bottom: 28%; transform: translateY(0) rotate(-8deg); max-width:160px; opacity:0.65; }
    .underlay .u4{ left: 8%; top: 18%; transform: rotate(4deg); max-width:160px; opacity:0.6; }
    .underlay .u5{ right: 6%; bottom: 6%; transform: rotate(4deg); max-width:160px; opacity:0.6; }

    /* ---------- Mobile / phone styles ---------- */
    @media (max-width:720px){
      :root { --gap:12px; --radius:14px; }
      header{gap:8px}
      .uploader{padding:10px; gap:10px}
      .filebtn{padding:8px 10px; font-size:0.9rem}
      .uploader input[type="text"]{padding:8px}
      .preview{gap:6px}
      .thumb{width:56px;height:56px}
      
      .meta{padding:10px}
      .caption{font-size:0.95rem}
      .comment-form input, .comment-form button{font-size:0.9rem;padding:8px}
      .user-controls{display:flex;gap:8px;align-items:center}
      /* 2-column grid on phones */
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 12px;
      }
      .card { border-radius:12px; overflow:hidden; }

      /* show full image on phones (no crop) */
      .imgwrap{
        position:relative;
        width:100%;
        height:auto;
        overflow:visible;
        background:#f8eef4;
      }
      .card img{
        display:block;
        width:100%;
        height:auto;
        object-fit:contain; /* show whole image on phones */
        object-position:center;
      }

      .underlay .u-img{ width: clamp(48px, 18vw, 200px); opacity:0.85; }
      .underlay .u1{ left: 4%; top: 62%; max-width:140px; }
      .underlay .u2{ left: 50%; top: 48%; width: clamp(100px, 60vw, 360px); opacity:0.45; }
      .underlay .u3{ left: 6%; bottom: 24%; max-width:120px; }
      .underlay .u4{ left: 4%; top: 8%; max-width:120px; }
      .underlay .u5{ right: 6%; bottom: 6%; max-width:120px; }
    }

    /* very narrow phones (single column) */
    @media (max-width:340px){
      html { font-size: 14px; }
      body{ padding:10px; }
      header h1{ font-size:18px; }
      .filebtn{ padding:7px 10px; font-size:0.88rem; }
      .uploader input[type="text"]{ padding:8px; font-size:0.9rem; }
      .thumb{ width:48px; height:48px; }
      .underlay .u-img{ width: clamp(40px, 20vw, 180px); opacity:0.85; filter: none; }
      .underlay .u2{ width: clamp(80px, 70vw, 320px); top:46%; opacity:0.4; }
      .meta{padding:8px}
      .comment-form input, .comment-form button{ padding:7px; font-size:0.86rem; }
      footer{ font-size:0.88rem; }
      .card{ border-radius:10px; }
      /* switch to single column for very small devices */
      .grid { grid-template-columns: 1fr; gap:10px; margin-top:12px; }
    }

    /* ensure page content stacks above the underlay */
    .wrap, header, main, footer, .modal, .modal-backdrop { position: relative; z-index: 10; }
    .modal-backdrop { z-index: 1000; }

  </style>
</head>
<body>
  <div class="underlay" aria-hidden="true">
    <img class="u-img u1" src="https://github.com/MGSarder/qxtdynamics/blob/main/1.jpg?raw=true" alt="">
    <img class="u-img u2" src="https://github.com/MGSarder/qxtdynamics/blob/main/2.jpg?raw=true" alt="">
    <img class="u-img u3" src="https://github.com/MGSarder/qxtdynamics/blob/main/3.jpg?raw=true" alt="">
    <img class="u-img u4" src="https://github.com/MGSarder/qxtdynamics/blob/main/4.jpg?raw=true" alt="">
    <img class="u-img u5" src="https://github.com/MGSarder/qxtdynamics/blob/main/5.jpg?raw=true" alt="">
  </div>

  <div class="wrap">
    <header>
      <div class="title-block">
        <h1>♡ Góc nhỏ của mụi và max ♡</h1>
        <p id="site-sub">Safe places dành cho long distance relationship của mụi và mã.</p>
      </div>
      <div class="user-controls">
        <div id="userDisplay" style="display:none" class="user-chip">
        <div class="uc-label">Cúc cu,</div>
        <div class="uc-name"><span id="userName">You</span></div>
      </div>
        <button id="loginBtn" class="link-btn">Log in</button>
        <button id="logoutBtn" class="link-btn" style="display:none">Log out</button>
      </div>
    </header>

    <section class="uploader">
      <div class="left">
        <div class="filewrap">
          <label class="filebtn" for="file">🌸 Chọn ảnh đi nà</label>
          <input id="file" type="file" accept="image/*" multiple>
          <input id="caption" type="text" placeholder="Lói gì đi" maxlength="220">
        </div>
        <div id="preview" class="preview"></div>
        <div class="note">Caption tối đa 220 kí tự hoy nha cục dàng</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;padding-bottom:18px">
        <button id="postBtn" class="filebtn">Post ♥</button>
      </div>
    </section>

    <main id="feed" class="grid"></main>

    <footer>Xa cách địa lý nhưng không xa cách <code style="font-weight:700">tình cảm</code> nhó   <img
    src="https://twemoji.maxcdn.com/v/latest/72x72/1f63c.png"
    alt="😼"
    class="emoji-img"
    width="20" height="20"
    aria-hidden="false"
  >
  .</footer>
  </div>

  <!-- login modal -->
  <div id="loginModal" style="display:none" class="modal-backdrop">
    <div class="modal">
      <h3>Enter your display name</h3>
      <input id="loginName" placeholder="Your name (e.g. Bunny)" maxlength="30">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="cancelLogin" class="btn-ghost">Cancel</button>
        <button id="confirmLogin" class="filebtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Supabase + app script (unchanged except keys) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://gfakpzqdsolzyihwwnvd.supabase.co";
    const SUPABASE_KEY = "sb_publishable_dFXVHx7R35VMP3NwftXT4g_iiYthAZZ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const fileInput = document.getElementById('file');
    const captionInput = document.getElementById('caption');
    const postBtn = document.getElementById('postBtn');
    const feed = document.getElementById('feed');
    const preview = document.getElementById('preview');

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userDisplay = document.getElementById('userDisplay');
    const userNameSpan = document.getElementById('userName');
    const loginModal = document.getElementById('loginModal');
    const loginName = document.getElementById('loginName');
    const confirmLogin = document.getElementById('confirmLogin');
    const cancelLogin = document.getElementById('cancelLogin');

    let selectedFiles = [];
    const USER_KEY = 'photo_wall_user_v1';
    const MAX_FILES = 20;

    function loadUser(){ try{ return JSON.parse(localStorage.getItem(USER_KEY)) }catch{return null} }
    function saveUser(u){ localStorage.setItem(USER_KEY, JSON.stringify(u)); updateUserUi(); }
    function clearUser(){ localStorage.removeItem(USER_KEY); updateUserUi(); }
    function updateUserUi(){ const u=loadUser(); if(u){ userDisplay.style.display='inline-flex'; userNameSpan.textContent=u.name; loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; document.getElementById('site-sub').textContent = 'Đăng nhập bởi: ' + u.name; } else { userDisplay.style.display='none'; loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; document.getElementById('site-sub').textContent='Safe places dành cho long distance relationship của mụi và mã.'; } }

    function escapeHtml(s){return (s||"").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]));}
    function createPreviewList(files){
      selectedFiles.forEach(f=>{ if(f.url) URL.revokeObjectURL(f.url); });
      selectedFiles = Array.from(files).slice(0, MAX_FILES).map(f=>({
        file: f,
        url: URL.createObjectURL(f),
        sizeKB: Math.round(f.size/1024)
      }));
      renderPreviews();
    }
    function renderPreviews(){
      preview.innerHTML='';
      selectedFiles.forEach((entry, idx)=>{
        const el=document.createElement('div'); el.className='thumb';
        el.innerHTML=`<img src="${entry.url}"><div class="remove">×</div><div class="label">${entry.sizeKB}KB</div>`;
        el.querySelector('.remove').onclick=()=>{ if(entry.url) URL.revokeObjectURL(entry.url); selectedFiles.splice(idx,1); renderPreviews(); };
        preview.appendChild(el);
      });
    }
    fileInput.onchange = e => { const files = e.target.files; if(!files || !files.length) return; createPreviewList(files); };

    function makeFilename(originalName){ const ext = (originalName.match(/\.[^.]+$/)||[''])[0]; let id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2,10); return `${Date.now()}-${id}${ext}`; }
    async function uploadFileToStorage(file){
      const path = makeFilename(file.name);
      const { data, error } = await supabase.storage.from("photos").upload(path, file, { cacheControl: '3600', upsert: false });
      if(error) throw error;
      const { data: pub } = supabase.storage.from("photos").getPublicUrl(data.path);
      if(!pub || !pub.publicUrl) throw new Error("Failed to get public URL");
      return pub.publicUrl;
    }
    async function uploadFileAndInsert(file, caption, author){
      const publicUrl = await uploadFileToStorage(file);
      const { error } = await supabase.from("posts").insert([{ author, caption, image_url: publicUrl }]);
      if(error) throw error;
      return publicUrl;
    }

    postBtn.onclick = async () => {
      if(!selectedFiles.length){ alert("Choose a photo first!"); return; }
      postBtn.disabled = true; const origText = postBtn.textContent; postBtn.textContent = "Posting...";
      try {
        const user = loadUser();
        const author = user ? user.name : "Anonymous";
        const caption = captionInput.value.trim().slice(0, 220);
        for(const entry of selectedFiles){ await uploadFileAndInsert(entry.file, caption, author); if(entry.url) URL.revokeObjectURL(entry.url); }
        selectedFiles = []; fileInput.value = ''; captionInput.value = ''; renderPreviews(); await loadFeed();
      } catch (err) { console.error(err); alert("Upload failed: " + (err.message || err)); } finally { postBtn.disabled = false; postBtn.textContent = origText; }
    };

    async function loadFeed(){
      feed.innerHTML = "<div style='grid-column:1/-1;text-align:center;color:var(--muted)'>Loading...</div>";
      try {
        const { data: posts, error } = await supabase.from("posts").select("id,author,caption,image_url,created_at,comments(id,author,text,created_at)").order("created_at", { ascending: false });
        if(error) throw error;
        feed.innerHTML = '';
        if(!posts || !posts.length){ feed.innerHTML = "<div style='grid-column:1/-1;text-align:center;color:var(--muted)'>Sao chưa đăng gì hết z ??? 🌸</div>"; return; }
        const currentUser = loadUser();
        posts.forEach(p=>{
          const card = document.createElement('article'); card.className='card';
          card.innerHTML = `
            <div class="imgwrap"><img src="${escapeHtml(p.image_url)}"><div class="heart" title="Like">♥</div></div>
            <div class="meta">
              <div class="meta-top"><div class="author">${escapeHtml(p.author)}</div><div class="time">${new Date(p.created_at).toLocaleString()}</div></div>
              <p class="caption">${escapeHtml(p.caption||"")}</p>
              <div class="controls"><button class="btn-ghost" data-dl>Download</button></div>
            </div>
            <div class="comments">
              <div class="comments-list"></div>
              <div class="commenting-as">Commenting as: <strong>${escapeHtml(currentUser?.name||"Anonymous")}</strong></div>
              <form class="comment-form"><input required placeholder="Write a comment..."><button>Comment</button></form>
            </div>`;
          const list = card.querySelector('.comments-list');
          (p.comments||[]).forEach(c=>{ const el = document.createElement('div'); el.className='comment'; el.innerHTML = `<span class="c-author">${escapeHtml(c.author)}</span>: ${escapeHtml(c.text)}<small>${new Date(c.created_at).toLocaleString()}</small>`; list.appendChild(el); });
          card.querySelector('[data-dl]').onclick = () => { const a = document.createElement('a'); a.href = p.image_url; a.download = "photo.jpg"; a.click(); };
          card.querySelector('.comment-form').onsubmit = async e => {
            e.preventDefault(); const input = e.target.querySelector('input'); const t = input.value.trim(); if(!t) return;
            try { const author = currentUser?.name || "Anonymous"; await supabase.from("comments").insert([{ post_id: p.id, author, text: t }]); input.value = ''; await loadFeed(); } catch(err){ console.error(err); alert("Failed to post comment: " + (err.message || err)); }
          };
          feed.appendChild(card);
        });
      } catch(err) { console.error(err); feed.innerHTML = "<div style='color:red'>Failed to load feed</div>"; }
    }

    // Realtime subscriptions
    try {
      supabase.channel('realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, () => loadFeed())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, () => loadFeed())
        .subscribe();
    } catch(e) { console.warn("Realtime subscription error:", e); }

    // login modal
    loginBtn.onclick = ()=>{ loginName.value=''; loginModal.style.display='flex'; setTimeout(()=>loginName.focus(),50); }
    cancelLogin.onclick = ()=> loginModal.style.display='none';
    confirmLogin.onclick = ()=>{ const n = loginName.value.trim(); if(!n){ alert("Enter a name"); return } saveUser({name:n}); loginModal.style.display='none'; }
    logoutBtn.onclick = ()=>{ if(confirm("Log out?")) clearUser(); }

    // init
    updateUserUi();
    loadFeed();
  </script>
</body>
</html>
