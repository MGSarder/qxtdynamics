<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Social Site</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #fafafa; }
    h1 { text-align: center; }
    form { margin-bottom: 20px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 8px; }
    input, textarea { width: 100%; margin: 6px 0; padding: 8px; }
    button { padding: 8px 12px; background: #007bff; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .post { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
    .post img { max-width: 100%; margin-top: 8px; border-radius: 6px; }
    .comments { margin-top: 10px; padding-left: 10px; border-left: 3px solid #eee; }
    .comment-form { margin-top: 8px; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Mini Social Feed</h1>

  <!-- Post Form -->
  <form id="post-form">
    <input type="text" id="author" placeholder="Your name" required />
    <textarea id="caption" placeholder="Write a caption..." required></textarea>
    <input type="file" id="image_file" accept="image/*" />
    <button type="submit">Post</button>
  </form>

  <!-- Feed -->
  <div id="feed"></div>

  <script>
    // ðŸ”‘ Supabase init
    const supabaseUrl = "YOUR_SUPABASE_URL";
    const supabaseKey = "YOUR_SUPABASE_ANON_KEY";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const feedEl = document.getElementById("feed");

    // Upload file to Supabase Storage and return public URL
    async function uploadImage(file) {
      if (!file) return null;

      const fileName = `${Date.now()}-${file.name}`;
      const { error } = await supabase.storage.from("post-images").upload(fileName, file);

      if (error) {
        console.error("Upload error:", error);
        return null;
      }

      const { data } = supabase.storage.from("post-images").getPublicUrl(fileName);
      return data.publicUrl;
    }

    // Create new post
    document.getElementById("post-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const author = document.getElementById("author").value.trim();
      const caption = document.getElementById("caption").value.trim();
      const file = document.getElementById("image_file").files[0];

      if (!author || !caption) return alert("Name and caption are required!");

      let image_url = null;
      if (file) {
        image_url = await uploadImage(file);
      }

      const { error } = await supabase.from("post").insert([{ author, caption, image_url }]);
      if (error) console.error(error);
      else {
        document.getElementById("caption").value = "";
        document.getElementById("image_file").value = "";
      }
    });

    // Add comment
    async function addComment(postId, author, comment) {
      const { error } = await supabase.from("comments").insert([{ post_id: postId, author, comment }]);
      if (error) console.error(error);
    }

    // Render feed
    async function loadFeed() {
      const { data: posts, error } = await supabase
        .from("post")
        .select("id, author, caption, image_url, created_at, comments(id, author, comment, created_at)")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      feedEl.innerHTML = "";
      posts.forEach(post => {
        const postDiv = document.createElement("div");
        postDiv.className = "post";
        postDiv.innerHTML = `
          <h3>${post.author}</h3>
          <p>${post.caption}</p>
          ${post.image_url ? `<img src="${post.image_url}" alt="Post image">` : ""}
          <div class="comments">
            ${post.comments.map(c => `<p><b>${c.author}:</b> ${c.comment}</p>`).join("")}
          </div>
          <form class="comment-form" data-post="${post.id}">
            <input type="text" name="author" placeholder="Your name" required />
            <input type="text" name="comment" placeholder="Write a comment..." required />
            <button type="submit">Comment</button>
          </form>
        `;
        feedEl.appendChild(postDiv);
      });

      // Attach comment form handlers
      document.querySelectorAll(".comment-form").forEach(form => {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const postId = form.dataset.post;
          const author = form.author.value.trim();
          const comment = form.comment.value.trim();
          if (!author || !comment) return;
          await addComment(postId, author, comment);
          form.comment.value = "";
        });
      });
    }

    // ðŸ”„ Realtime updates for posts + comments
    supabase
      .channel("realtime")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "post" }, () => loadFeed())
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "comments" }, () => loadFeed())
      .subscribe();

    // Initial load
    loadFeed();
  </script>
</body>
</html>
